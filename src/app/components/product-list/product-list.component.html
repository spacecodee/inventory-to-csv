<div class="w-full max-w-7xl mx-auto p-3 sm:p-6">
  <div class="flex flex-col gap-4 sm:gap-6 mb-4 sm:mb-6">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
      <h2 class="text-xl sm:text-2xl font-bold text-foreground">
        Productos Generados ({{ products().length }})
      </h2>

      <div class="flex flex-wrap gap-2 sm:gap-3">
        <button
          (click)="clearList()"
          class="flex-1 sm:flex-none px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm border border-destructive/30 text-destructive hover:bg-destructive/10 transition-colors flex items-center justify-center gap-2"
          [disabled]="products().length === 0"
        >
          <ng-icon hlm name="lucideTrash2" size="sm"></ng-icon>
          <span class="hidden sm:inline">Limpiar</span>
        </button>

        <button
          (click)="downloadBarcodes()"
          class="flex-1 sm:flex-none px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm bg-secondary text-secondary-foreground hover:bg-secondary/80 transition-colors flex items-center justify-center gap-2 shadow-sm"
          [disabled]="paginatedProducts().length === 0"
          title="Descargar códigos de barras de la página actual"
        >
          <ng-icon hlm name="lucideScanBarcode" size="sm"></ng-icon>
          <span class="hidden sm:inline">Descargar Códigos</span>
        </button>

        <button
          (click)="downloadExcel()"
          class="flex-1 sm:flex-none px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm bg-primary text-primary-foreground hover:bg-primary/90 transition-colors flex items-center justify-center gap-2 shadow-sm"
          [disabled]="products().length === 0"
        >
          <ng-icon hlm name="lucideDownload" size="sm"></ng-icon>
          <span class="hidden sm:inline">Descargar Excel</span>
        </button>
      </div>
    </div>

    <!-- Filters & Search -->
    <div
      class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-between items-start sm:items-center bg-card p-3 sm:p-4 rounded-xl border border-border shadow-sm"
    >
      <!-- Search -->
      <div class="relative w-full sm:flex-1">
        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">
          <ng-icon hlm name="lucideSearch" size="sm"></ng-icon>
        </div>
        <input
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event)"
          type="text"
          placeholder="Buscar..."
          class="w-full pl-10 pr-4 py-2 text-sm sm:text-base rounded-lg bg-secondary/20 border border-border focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all"
        />
      </div>

      <!-- Column Toggle -->
      <div class="relative w-full sm:w-auto">
        <button
          (click)="toggleDropdown()"
          class="w-full sm:w-auto px-4 py-2 rounded-lg bg-secondary/20 border border-border hover:bg-secondary/40 transition-colors flex items-center justify-center gap-2 text-xs sm:text-sm font-medium"
        >
          <ng-icon hlm name="lucideSettings2" size="sm"></ng-icon>
          Columnas
        </button>

        <!-- Dropdown -->
        @if (isDropdownOpen()) {
          <div
            class="absolute right-0 top-full mt-2 w-full sm:w-56 bg-card rounded-lg shadow-lg border border-border p-2 z-10"
          >
            <div class="text-[10px] sm:text-xs font-semibold text-muted-foreground px-2 py-1 mb-1">
              Mostrar Columnas
            </div>
            @for (col of availableColumns(); track col.key) {
              <button
                (click)="toggleColumn(col.key)"
                class="w-full flex items-center justify-between px-2 py-1.5 rounded-md hover:bg-secondary/20 text-xs sm:text-sm transition-colors"
                [class.opacity-50]="col.alwaysVisible"
                [disabled]="col.alwaysVisible"
              >
                <span>{{ col.label }}</span>
                @if (col.visible) {
                  <ng-icon hlm name="lucideCheck" size="sm" class="text-primary"></ng-icon>
                }
              </button>
            }
          </div>
        }
      </div>
    </div>
  </div>

  @if (products().length === 0) {
    <div
      class="text-center py-12 sm:py-20 bg-secondary/30 rounded-xl border border-dashed border-border"
    >
      <p class="text-sm sm:text-base text-muted-foreground">No hay productos procesados aún.</p>
    </div>
  } @else {
    <div class="overflow-x-auto rounded-xl border border-border bg-card shadow-sm">
      <table class="w-full text-xs sm:text-sm text-left min-w-[640px]">
        <thead
          class="text-[10px] sm:text-xs text-muted-foreground uppercase bg-secondary/50 border-b border-border"
        >
        <tr>
          @if (columnVisibility()['imagen']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">Imagen</th>
          }
          @if (columnVisibility()['nombre']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">Nombre</th>
          }
          @if (columnVisibility()['categoria']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">Categoría</th>
          }
          @if (columnVisibility()['marca']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">Marca</th>
          }
          @if (columnVisibility()['descripcion']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">Descripción</th>
          }
          @if (columnVisibility()['stock']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">Stock</th>
          }
          @if (columnVisibility()['precioCompra']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">P. Compra</th>
          }
          @if (columnVisibility()['precioVenta']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">P. Venta</th>
          }
          @if (columnVisibility()['codigoInterno']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">Código</th>
          }
          @if (columnVisibility()['codigoBarras']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">Código Barras</th>
          }
          @if (columnVisibility()['acciones']) {
            <th class="px-3 sm:px-6 py-2 sm:py-3">Acciones</th>
          }
        </tr>
        </thead>
        <tbody>
          @for (product of paginatedProducts(); track product.id) {
            <tr class="bg-card border-b border-border hover:bg-secondary/20 transition-colors">
              @if (columnVisibility()['imagen']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4">
                  <div
                    class="w-10 h-10 sm:w-12 sm:h-12 rounded-md bg-secondary overflow-hidden flex items-center justify-center text-[10px] sm:text-xs text-muted-foreground"
                  >
                    IMG
                  </div>
                </td>
              }
              @if (columnVisibility()['nombre']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4 font-medium text-foreground">
                  {{ product.nombre }}
                </td>
              }
              @if (columnVisibility()['categoria']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4">
            <span
              class="px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full bg-primary/10 text-primary-foreground text-[10px] sm:text-xs font-medium"
              style="color: var(--primary)"
            >
              {{ product.categoria }}
            </span>
                </td>
              }
              @if (columnVisibility()['marca']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-muted-foreground">{{ product.marca }}</td>
              }
              @if (columnVisibility()['descripcion']) {
                <td
                  class="px-3 sm:px-6 py-3 sm:py-4 text-muted-foreground max-w-[150px] sm:max-w-xs truncate"
                  [title]="product.descripcion"
                >
                  {{ product.descripcion }}
                </td>
              }
              @if (columnVisibility()['stock']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-muted-foreground">{{ product.stock }}</td>
              }
              @if (columnVisibility()['precioCompra']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-muted-foreground">
                  S/ {{ product.precioUnitarioCompra | number : '1.2-2' }}
                </td>
              }
              @if (columnVisibility()['precioVenta']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4 font-medium text-primary">
                  S/ {{ product.precioUnitarioVenta | number : '1.2-2' }}
                </td>
              }
              @if (columnVisibility()['codigoInterno']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-muted-foreground">
                  {{ product.codigoInterno }}
                </td>
              }
              @if (columnVisibility()['codigoBarras']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4 font-mono text-[10px] sm:text-xs">
                  {{ product.codigoBarras }}
                </td>
              }
              @if (columnVisibility()['acciones']) {
                <td class="px-3 sm:px-6 py-3 sm:py-4">
                  <div class="flex gap-1 sm:gap-2">
                    <button
                      (click)="openPriceCalculator(product)"
                      class="text-amber-500 hover:text-amber-400 transition-colors p-1"
                      title="Calcular Precio de Venta"
                    >
                      <ng-icon hlm name="lucideCalculator" size="sm"></ng-icon>
                    </button>
                    <button
                      (click)="openStockEditor(product)"
                      class="text-emerald-500 hover:text-emerald-400 transition-colors p-1"
                      title="Editar Stock"
                    >
                      <ng-icon hlm name="lucidePackage" size="sm"></ng-icon>
                    </button>
                    <button
                      (click)="openBarcodeSuffixEditor(product)"
                      class="text-violet-500 hover:text-violet-400 transition-colors p-1"
                      title="Editar Sufijo Codigo de Barras"
                    >
                      <ng-icon hlm name="lucideTag" size="sm"></ng-icon>
                    </button>
                    <button
                      (click)="openSunatCodeEditor(product)"
                      class="text-cyan-500 hover:text-cyan-400 transition-colors p-1"
                      title="Editar Codigo SUNAT"
                    >
                      <ng-icon hlm name="lucideFileCode" size="sm"></ng-icon>
                    </button>
                    <button
                      (click)="openCategoryEditor(product)"
                      class="text-orange-500 hover:text-orange-400 transition-colors p-1"
                      title="Cambiar Categoria"
                    >
                      <ng-icon hlm name="lucideFolderOpen" size="sm"></ng-icon>
                    </button>
                    <button
                      (click)="viewProduct(product)"
                      class="text-primary hover:text-primary/80 transition-colors p-1"
                      title="Ver Detalle"
                    >
                      <ng-icon hlm name="lucideEye" size="sm"></ng-icon>
                    </button>
                    <button
                      (click)="removeProduct(product.id)"
                      class="text-destructive hover:text-destructive/80 transition-colors p-1"
                      title="Eliminar"
                    >
                      <ng-icon hlm name="lucideX" size="sm"></ng-icon>
                    </button>
                  </div>
                </td>
              }
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div
      class="flex flex-col sm:flex-row justify-between items-center gap-3 sm:gap-4 mt-3 sm:mt-4 text-xs sm:text-sm text-muted-foreground"
    >
      <div class="flex items-center gap-2">
        <span class="text-[10px] sm:text-sm">Mostrar</span>
        <select
          [ngModel]="itemsPerPage()"
          (ngModelChange)="updateItemsPerPage($event)"
          class="bg-card border border-border rounded px-2 py-1 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-primary/50"
        >
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
        </select>
        <span class="text-[10px] sm:text-sm">por página</span>
      </div>

      <div class="flex items-center gap-2">
      <span class="text-[10px] sm:text-sm"
      >{{ (currentPage() - 1) * itemsPerPage() + 1 }} -
        {{ Math.min(currentPage() * itemsPerPage(), filteredProducts().length) }} de
        {{ filteredProducts().length }}</span
      >

        <div class="flex gap-1">
          <button
            (click)="prevPage()"
            [disabled]="currentPage() === 1"
            class="px-2 sm:px-3 py-1 text-xs sm:text-sm rounded border border-border hover:bg-secondary/50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Anterior
          </button>
          <button
            (click)="nextPage()"
            [disabled]="currentPage() * itemsPerPage() >= filteredProducts().length"
            class="px-2 sm:px-3 py-1 text-xs sm:text-sm rounded border border-border hover:bg-secondary/50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Siguiente
          </button>
        </div>
      </div>
    </div>
  }
</div>

@if (activeProduct()) {
  <app-product-detail
    [product]="activeProduct()!"
    (closeModal)="selectedProductId.set(null)"
  ></app-product-detail>
}
@if (priceCalcProduct()) {
  <app-price-calculator-dialog
    [product]="priceCalcProduct()!"
    (closeDialog)="closePriceCalculator()"
    (apply)="applyCalculatedPrice($event)"
  ></app-price-calculator-dialog>
}
@if (stockEditorProduct()) {
  <app-stock-editor-dialog
    [product]="stockEditorProduct()!"
    (closeDialog)="closeStockEditor()"
    (apply)="applyStockChanges($event)"
  ></app-stock-editor-dialog>
}
@if (barcodeSuffixProduct()) {
  <app-barcode-suffix-dialog
    [product]="barcodeSuffixProduct()!"
    (closeDialog)="closeBarcodeSuffixEditor()"
    (apply)="applyBarcodeSuffix($event)"
  ></app-barcode-suffix-dialog>
}
@if (sunatCodeProduct()) {
  <app-sunat-code-dialog
    [product]="sunatCodeProduct()!"
    (closeDialog)="closeSunatCodeEditor()"
    (apply)="applySunatCode($event)"
  ></app-sunat-code-dialog>
}
@if (categoryEditorProduct()) {
  <app-category-editor-dialog
    [product]="categoryEditorProduct()!"
    (closeDialog)="closeCategoryEditor()"
    (apply)="applyCategory($event)"
  ></app-category-editor-dialog>
}
