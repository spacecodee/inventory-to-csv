<div class="fixed inset-0 z-50 flex items-center justify-center p-4">
  <button
    type="button"
    class="absolute inset-0 w-full h-full bg-black/50 backdrop-blur-sm border-none cursor-default"
    (click)="closeModal.emit()"
    aria-label="Cerrar modal"
  ></button>

  <dialog
    open
    class="relative z-10 bg-card w-full max-w-4xl max-h-[90vh] rounded-xl shadow-xl overflow-hidden flex flex-col pointer-events-auto border-none p-0 m-0"
    (click)="$event.stopPropagation()"
    (keydown)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="flex justify-between items-center p-6 border-b border-border bg-secondary/20">
      <h2 class="text-2xl font-bold text-foreground">
        {{ isEditing() ? 'Editar Producto' : 'Detalle del Producto' }}
      </h2>
      <div class="flex items-center gap-2">
        @if (!isEditing()) {
          <button
            (click)="enableEdit()"
            class="text-muted-foreground hover:text-primary transition-colors p-2"
            title="Editar"
          >
            <ng-icon hlm [name]="editIcon" size="lg"></ng-icon>
          </button>
        }
        <button
          (click)="closeModal.emit()"
          class="text-muted-foreground hover:text-foreground transition-colors p-2"
          title="Cerrar"
        >
          <ng-icon hlm [name]="closeIcon" size="lg"></ng-icon>
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="overflow-y-auto p-6 flex-1">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Images Section (Always Read-Only) -->
        <div class="col-span-1 md:col-span-2 mb-4">
          <h3 class="text-lg font-semibold mb-3 text-primary">Imágenes</h3>
          <div class="flex gap-4 overflow-x-auto pb-2">
            @if (imageUrls().length > 0) {
              @for (item of imageUrls(); track $index) {
                <div
                  class="relative group rounded-lg overflow-hidden border border-border w-48 h-48 flex-shrink-0 bg-secondary/10"
                >
                  <img [src]="item.url" class="w-full h-full object-cover" [alt]="item.name"/>
                  <div
                    class="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-xs p-1 truncate text-center"
                  >
                    {{ item.name }}
                  </div>
                </div>
              }
            } @else {
              <div
                class="p-4 border border-dashed border-border rounded-lg text-muted-foreground w-full text-center"
              >
                No hay previsualización de imágenes disponible.
                <div class="mt-2 text-xs">
                  Archivos originales: {{ product().imagenes.join(', ') }}
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Fields -->
        @if (isEditing()) {
          <form [formGroup]="form" class="contents">
            @for (field of fields; track field.key) {
              @if (field.key !== 'imagenes') {
                <div class="flex flex-col gap-1">
                  <label
                    [for]="field.key"
                    class="text-xs font-medium text-muted-foreground uppercase tracking-wider"
                  >
                    {{ field.label }}
                  </label>
                  @if (field.type === 'boolean') {
                    <select
                      [id]="field.key"
                      [formControlName]="field.key"
                      class="p-2 rounded-lg bg-background border border-input focus:ring-2 focus:ring-ring"
                    >
                      <option [ngValue]="true">Sí</option>
                      <option [ngValue]="false">No</option>
                    </select>
                  } @else {
                    <input
                      [id]="field.key"
                      [type]="field.type || 'text'"
                      [formControlName]="field.key"
                      class="p-2 rounded-lg bg-background border border-input focus:ring-2 focus:ring-ring"
                    />
                  }
                </div>
              }
            }
          </form>
        } @else {
          @for (field of fields; track field.label) {
            <div class="flex flex-col gap-1 p-3 rounded-lg bg-secondary/10 border border-border/50">
          <span class="text-xs font-medium text-muted-foreground uppercase tracking-wider">{{
              field.label
            }}</span>
              <span class="font-medium text-foreground break-words">{{ getValue(field.key) }}</span>
            </div>
          }
        }
      </div>
    </div>

    <!-- Footer -->
    <div class="p-4 border-t border-border bg-secondary/20 flex justify-end gap-3">
      @if (isEditing()) {
        <button
          (click)="cancelEdit()"
          class="px-6 py-2 bg-secondary text-secondary-foreground rounded-lg hover:bg-secondary/80 transition-colors"
        >
          Cancelar
        </button>
        <button
          (click)="saveEdit()"
          [disabled]="form.invalid"
          class="px-6 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors flex items-center gap-2"
        >
          <ng-icon hlm [name]="saveIcon" size="sm"></ng-icon>
          Guardar
        </button>
      } @else {
        <button
          (click)="closeModal.emit()"
          class="px-6 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
        >
          Cerrar
        </button>
      }
    </div>
  </dialog>
</div>
